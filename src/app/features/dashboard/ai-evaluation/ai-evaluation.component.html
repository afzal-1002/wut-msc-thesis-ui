<!-- ...existing code... -->


<!-- Main evaluation card content ... -->

<div class="container mt-4 ai-evaluation-page">
  <h2 class="mb-3 ai-evaluation-title">Evaluation Analysis</h2>
  <p class="text-muted mb-4">High-level insights: How good is the AI? Which model performs better?</p>

  <div class="mb-2 d-flex justify-content-end">
    <button class="btn btn-outline-secondary btn-sm evaluation-back-btn" (click)="goBack()">
      ← Back to AI Estimations
    </button>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <!-- ...existing controls and tabs... -->

      <div class="evaluation-top-card">
        <div class="d-flex flex-wrap align-items-end evaluation-top-row">
          <div class="mb-2 me-3">
            <button class="btn btn-primary btn-sm evaluation-run-btn" (click)="runEvaluation()" [disabled]="isLoadingEvaluation">
              <span *ngIf="!isLoadingEvaluation">Run Evaluation</span>
              <span *ngIf="isLoadingEvaluation">Running...</span>
            </button>
          </div>
          <div class="flex-grow-1 mb-2 evaluation-input-wrapper">
            <ng-container [ngSwitch]="activeEvaluationTab">
              <div *ngSwitchCase="'by-issue'">
                <label class="form-label mb-1 visually-hidden">Issue Key</label>
                <input
                  class="form-control form-control-sm"
                  [(ngModel)]="evalIssueKey"
                  placeholder="Issue Key (e.g. BUG-5)"
                />
              </div>
              <div *ngSwitchCase="'by-model'">
                <label class="form-label mb-1 visually-hidden">AI Provider</label>
                <select class="form-select form-select-sm" [(ngModel)]="evalProvider">
                  <option [ngValue]="null" disabled selected>AI Provider</option>
                  <option value="GEMINI">Gemini</option>
                  <option value="DEEPSEEK">DeepSeek</option>
                </select>
              </div>
              <div *ngSwitchCase="'stability'">
                <label class="form-label mb-1 visually-hidden">Issue Key (for stability)</label>
                <input
                  class="form-control form-control-sm"
                  [(ngModel)]="stabilityIssueKey"
                  placeholder="Issue Key for stability (e.g. BUG-5)"
                />
              </div>
              <div *ngSwitchDefault></div>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Evaluation modes: centered inner card with tabs -->
      <div class="evaluation-modes-card">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div class="evaluation-tabs-title small text-muted">Evaluation modes</div>
        </div>
        <ul class="nav nav-pills small mb-0 evaluation-tabs">
          <li class="nav-item"><button class="nav-link" [class.active]="activeEvaluationTab === 'by-issue'" (click)="activeEvaluationTab = 'by-issue'">By Issue</button></li>
          <li class="nav-item"><button class="nav-link" [class.active]="activeEvaluationTab === 'comparison'" (click)="activeEvaluationTab = 'comparison'">Model Comparison</button></li>
          <li class="nav-item"><button class="nav-link" [class.active]="activeEvaluationTab === 'by-model'" (click)="activeEvaluationTab = 'by-model'">By AI Model</button></li>
          <li class="nav-item"><button class="nav-link" [class.active]="activeEvaluationTab === 'features'" (click)="activeEvaluationTab = 'features'">Feature Impact</button></li>
          <li class="nav-item"><button class="nav-link" [class.active]="activeEvaluationTab === 'stability'" (click)="activeEvaluationTab = 'stability'">Stability Analysis</button></li>
        </ul>
      </div>

      <div class="evaluation-content">
        <div *ngIf="evaluationResult" class="mt-3">

          <!-- Provider comparison bar chart (By Issue: avg hours per model) -->
          <div *ngIf="hasProviderStats && maxProviderAvgHours > 0" class="mt-4 text-center">
            <div class="chart-center-wrap">
              <canvas baseChart
                [data]="providerBarData"
                [options]="providerBarOptions"
                [type]="providerBarType"
                style="max-width: 420px; min-height: 220px;"></canvas>
              <p class="chart-caption small text-muted mt-1 text-center">
                Figure 1: Average estimated resolution time (hours) for Gemini vs DeepSeek.
              </p>
            </div>

            <!-- By Issue: Average analysis time (seconds) per model -->
            <div *ngIf="activeEvaluationTab === 'by-issue' && byIssueTimeBarData && byIssueTimeBarData.datasets[0].data.length" class="mt-4 text-center">
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="byIssueTimeBarData"
                  [options]="byIssueTimeBarOptions"
                  [type]="byIssueTimeBarType"
                  style="max-width: 420px; min-height: 220px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure 2: Average analysis time in seconds for Gemini vs DeepSeek (per issue).
                </p>
              </div>
            </div>

            <!-- By Issue: Detailed stats for Gemini vs DeepSeek -->
            <div *ngIf="activeEvaluationTab === 'by-issue' && byIssueAllStatsBarData && byIssueAllStatsBarData.datasets[0].data.length" class="mt-4 text-center">
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="byIssueAllStatsBarData"
                  [options]="byIssueAllStatsBarOptions"
                  [type]="byIssueAllStatsBarType"
                  style="max-width: 620px; min-height: 260px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure 3: Detailed statistics per model (Gemini vs DeepSeek) – avg hours, avg time in seconds, runs, and min/max estimated hours.
                </p>
              </div>
            </div>

            <!-- By Issue: Overall issue statistics only -->
            <div *ngIf="activeEvaluationTab === 'by-issue' && byIssueOverallBarData && byIssueOverallBarData.datasets[0].data.length" class="mt-4 text-center">
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="byIssueOverallBarData"
                  [options]="byIssueOverallBarOptions"
                  [type]="byIssueOverallBarType"
                  style="max-width: 420px; min-height: 220px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure 4: Overall statistics for this issue (e.g. BUG-5) – avg hours, avg time in seconds, total runs, and min/max estimated hours.
                </p>
              </div>
            </div>
          </div>


          <!-- Markdown Feature Impact: Two pie charts (Enabled vs Disabled) and comparative bar chart -->
          <div *ngIf="activeEvaluationTab === 'features' && evaluationResult" class="mt-3">
            <!-- Top: Two pie charts -->
            <div class="mb-4 text-center">
              <h6>Markdown Feature Impact (Pie Charts)</h6>
              <div class="d-flex justify-content-center flex-wrap mt-2">
                <div class="chart-center-wrap me-4 mb-3" *ngIf="markdownEnabledPieData">
                  <h6 class="small fw-semibold mb-1">Markdown Enabled</h6>
                  <canvas baseChart
                    [data]="markdownEnabledPieData"
                    [options]="markdownPieOptions"
                    [type]="markdownPieType"
                    style="max-width: 260px; min-height: 220px;"></canvas>
                  <p class="chart-caption small text-muted mt-1 text-center">
                    Figure: Total runs and average analysis time in seconds when Markdown is enabled.
                  </p>
                </div>

                <div class="chart-center-wrap mb-3" *ngIf="markdownDisabledPieData">
                  <h6 class="small fw-semibold mb-1">Markdown Disabled</h6>
                  <canvas baseChart
                    [data]="markdownDisabledPieData"
                    [options]="markdownPieOptions"
                    [type]="markdownPieType"
                    style="max-width: 260px; min-height: 220px;"></canvas>
                  <p class="chart-caption small text-muted mt-1 text-center">
                    Figure: Total runs and average analysis time in seconds when Markdown is disabled.
                  </p>
                </div>
              </div>
            </div>

            <!-- Bottom: Bar chart comparing Enabled vs Disabled -->
            <div class="mb-4 text-center" *ngIf="markdownBarData && markdownBarData.datasets[0].data.length">
              <h6>Markdown Enabled vs Disabled (Bar Chart)</h6>
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="markdownBarData"
                  [options]="markdownBarOptions"
                  [type]="markdownBarType"
                  style="max-width: 480px; min-height: 240px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure: Comparison of total runs and average analysis time in seconds between Markdown enabled and disabled.
                </p>
              </div>
            </div>
          </div>

          <!-- By AI Model: Pie chart (Total runs, Avg analysis time (sec), Avg estimated hours) -->
          <div *ngIf="activeEvaluationTab === 'by-model' && modelByModelPieData" class="text-center mt-4">
            <h6>Model Overview - Pie Chart</h6>
            <div class="chart-center-wrap">
              <canvas baseChart
                [data]="modelByModelPieData"
                [options]="modelByModelPieOptions"
                [type]="modelByModelPieType"
                style="max-width: 360px; min-height: 240px;"></canvas>
              <p class="chart-caption small text-muted mt-1 text-center">
                Figure: Relative contribution of total runs, average analysis time in seconds, and average estimated hours for the selected model.
              </p>
            </div>
          </div>

          <!-- By AI Model: Bar chart with all key stats (seconds for time) -->
          <div *ngIf="activeEvaluationTab === 'by-model' && modelByModelBarData && modelByModelBarData.datasets[0].data.length" class="text-center mt-4">
            <h6>Model Overview - Key Statistics</h6>
            <div class="chart-center-wrap">
              <canvas baseChart
                [data]="modelByModelBarData"
                [options]="modelByModelBarOptions"
                [type]="modelByModelBarType"
                style="max-width: 520px; min-height: 240px;"></canvas>
              <p class="chart-caption small text-muted mt-1 text-center">
                Figure: Total runs, unique issues, average analysis time in seconds, and average estimated hours for the selected AI model.
              </p>
            </div>
          </div>

          <!-- Stability Analysis: Bar chart and Radar chart for a single issue -->
          <div *ngIf="activeEvaluationTab === 'stability'" class="mt-4 text-center">
            <div *ngIf="stabilityBarData && stabilityBarData.datasets[0].data.length" class="mb-4">
              <h6>Stability Summary - Bar Chart (Issue {{ evaluationResult.issueKey || stabilityIssueKey }})</h6>
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="stabilityBarData"
                  [options]="stabilityBarOptions"
                  [type]="stabilityBarType"
                  style="max-width: 520px; min-height: 240px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure: Minimum hours, average hours, maximum hours, and standard deviation of estimated hours for the selected issue.
                </p>
              </div>
            </div>

            <div *ngIf="stabilityLineData" class="mb-4">
              <h6>Stability Trend - Line Chart (Issue {{ evaluationResult.issueKey || stabilityIssueKey }})</h6>
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="stabilityLineData"
                  [options]="stabilityLineOptions"
                  [type]="stabilityLineType"
                  style="max-width: 520px; min-height: 240px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure: Line view of minimum, average, maximum hours and standard deviation in hours for the selected issue.
                </p>
              </div>
            </div>

            <div *ngIf="stabilityPieData" class="mb-4">
              <h6>Stability Composition - Pie Chart (Issue {{ evaluationResult.issueKey || stabilityIssueKey }})</h6>
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="stabilityPieData"
                  [options]="stabilityPieOptions"
                  [type]="stabilityPieType"
                  style="max-width: 320px; min-height: 240px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure: Proportion of minimum, average, maximum hours and standard deviation (in hours) for the selected issue.
                </p>
              </div>
            </div>

            <div *ngIf="stabilityRadarData" class="mb-2">
              <h6>Stability Profile - Radar Chart (Issue {{ evaluationResult.issueKey || stabilityIssueKey }})</h6>
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="stabilityRadarData"
                  [options]="stabilityRadarOptions"
                  [type]="stabilityRadarType"
                  style="max-width: 420px; min-height: 260px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure: Radar view of minimum, average, maximum hours and standard deviation in hours for the selected issue.
                </p>
              </div>
            </div>
          </div>

          <!-- Model Comparison: Performance charts (Gemini vs DeepSeek) -->
          <div *ngIf="activeEvaluationTab === 'comparison'" class="mt-4 text-center">
            <div *ngIf="comparisonPerfAvgBarData && comparisonPerfAvgBarData.labels?.length" class="mb-4">
              <h6>Model Comparison - Average Response Time</h6>
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="comparisonPerfAvgBarData"
                  [options]="comparisonPerfAvgBarOptions"
                  [type]="comparisonPerfAvgBarType"
                  style="max-width: 420px; min-height: 220px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure A: Average response time (seconds) for Gemini vs DeepSeek across all evaluation runs.
                </p>
              </div>
            </div>

            <div *ngIf="comparisonPerfDetailBarData && comparisonPerfDetailBarData.labels?.length" class="mb-2">
              <h6>Performance Distribution - Min, Avg, Max, Std Dev</h6>
              <div class="chart-center-wrap">
                <canvas baseChart
                  [data]="comparisonPerfDetailBarData"
                  [options]="comparisonPerfDetailBarOptions"
                  [type]="comparisonPerfDetailBarType"
                  style="max-width: 620px; min-height: 260px;"></canvas>
                <p class="chart-caption small text-muted mt-1 text-center">
                  Figure B: Distribution of response times for each model (minimum, average, maximum, and standard deviation in seconds) – addressing the performance/speed research question.
                </p>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <h6>Raw Evaluation Result</h6>
            <pre class="small bg-light p-2 border rounded">{{ evaluationResult | json }}</pre>
          </div>
        </div>
      </div>
    </div>
