<div class="container mt-4 history-page">
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h2 class="mb-1">Estimation History Analysis</h2>
      <p class="text-muted mb-0">Comprehensive visual analysis of AI estimation patterns and performance.</p>
    </div>
    <button class="btn btn-outline-secondary btn-sm history-back-btn" (click)="goBack()">
      &larr; Back to History
    </button>
  </div>

  <div *ngIf="isLoading" class="alert alert-info">Loading estimation data...</div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

  <ng-container *ngIf="!isLoading && !error">
    <!-- Filter Card -->
    <div class="card filter-card mb-4">
      <div class="card-body">
        <h6 class="card-title mb-3">Filters</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label small">Issue</label>
            <select class="form-select form-select-sm" [(ngModel)]="selectedIssue" (change)="filterData()">
              <option value="">All Issues</option>
              <option *ngFor="let issue of allIssues" [value]="issue">{{ issue }}</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small">AI Provider</label>
            <select class="form-select form-select-sm" [(ngModel)]="selectedProvider" (change)="filterData()">
              <option value="">All Providers</option>
              <option value="GEMINI">GEMINI</option>
              <option value="DEEPSEEK">DEEPSEEK</option>
            </select>
          </div>
          <div class="col-md-4">
            <button class="btn btn-sm btn-outline-secondary w-100 mt-4" (click)="selectedIssue=''; selectedProvider=''; filterData()">
              Reset Filters
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Chart 1: Estimation Comparison -->
      <div class="card chart-card">
        <div class="card-body">
          <h6 class="card-title">ðŸ“Š Estimation Comparison by Model</h6>
          <p class="card-text small text-muted">Average effort estimations generated by different AI providers across issues.</p>
          <div class="chart-container">
            <canvas baseChart 
              [data]="estimationComparisonChartConfig.data"
              [options]="estimationComparisonChartConfig.options"
              [type]="estimationComparisonChartConfig.type">
            </canvas>
          </div>
          <p class="small text-muted mt-2 thesis-note">
            <strong>Thesis Angle:</strong> The chart compares average effort estimations generated by different AI providers across identical issues, revealing systematic differences in prediction behavior.
          </p>
        </div>
      </div>

      <!-- Chart 2: Stability Over Time -->
      <div class="card chart-card">
        <div class="card-body">
          <h6 class="card-title">ðŸ“ˆ Estimation Stability Over Time</h6>
          <p class="card-text small text-muted">Temporal analysis of estimation variance between providers.</p>
          <div class="chart-container">
            <canvas baseChart 
              [data]="stabilityOverTimeChartConfig.data"
              [options]="stabilityOverTimeChartConfig.options"
              [type]="stabilityOverTimeChartConfig.type">
            </canvas>
          </div>
          <p class="small text-muted mt-2 thesis-note">
            <strong>Thesis Angle:</strong> Temporal analysis reveals that DeepSeek produces more stable estimations, whereas Gemini exhibits higher variance over repeated evaluations.
          </p>
        </div>
      </div>

      <!-- Chart 3: Performance Metrics -->
      <div class="card chart-card">
        <div class="card-body">
          <h6 class="card-title">âš¡ Analysis Time Comparison</h6>
          <p class="card-text small text-muted">Performance efficiency metrics for each AI provider.</p>
          <div class="chart-container">
            <canvas baseChart 
              [data]="performanceChartConfig.data"
              [options]="performanceChartConfig.options"
              [type]="performanceChartConfig.type">
            </canvas>
          </div>
          <p class="small text-muted mt-2 thesis-note">
            <strong>Thesis Angle:</strong> Response latency comparison highlights the trade-off between computational cost and explanatory depth.
          </p>
        </div>
      </div>

      <!-- Chart 4: Explanation Impact -->
      <div class="card chart-card">
        <div class="card-body">
          <h6 class="card-title">ðŸ’¡ Explanation Impact on Estimation</h6>
          <p class="card-text small text-muted">Effect of enabling explanations on average estimations.</p>
          <div class="chart-container">
            <canvas baseChart 
              [data]="explanationImpactChartConfig.data"
              [options]="explanationImpactChartConfig.options"
              [type]="explanationImpactChartConfig.type">
            </canvas>
          </div>
          <p class="small text-muted mt-2 thesis-note">
            <strong>Thesis Angle:</strong> Enabling explanation generation slightly increases estimation variance, suggesting deeper reasoning paths influence effort prediction.
          </p>
        </div>
      </div>

      <!-- Chart 5: Prompt Impact -->
      <div class="card chart-card">
        <div class="card-body">
          <h6 class="card-title">ðŸŽ¯ Human Prompt Influence on Estimation</h6>
          <p class="card-text small text-muted">Impact of user-provided prompts on AI behavior.</p>
          <div class="chart-container">
            <canvas baseChart 
              [data]="promptImpactChartConfig.data"
              [options]="promptImpactChartConfig.options"
              [type]="promptImpactChartConfig.type">
            </canvas>
          </div>
          <p class="small text-muted mt-2 thesis-note">
            <strong>Thesis Angle:</strong> User-provided prompts significantly influence both estimation magnitude and analysis latency.
          </p>
        </div>
      </div>

      <!-- Chart 6: Usage Distribution -->
      <div class="card chart-card">
        <div class="card-body">
          <h6 class="card-title">ðŸ“‹ AI Usage Distribution</h6>
          <p class="card-text small text-muted">Distribution of API calls across AI providers.</p>
          <div class="chart-container">
            <canvas baseChart 
              [data]="usageDistributionChartConfig.data"
              [options]="usageDistributionChartConfig.options"
              [type]="usageDistributionChartConfig.type">
            </canvas>
          </div>
          <p class="small text-muted mt-2 thesis-note">
            <strong>Thesis Angle:</strong> The dataset contains a balanced distribution of AI provider invocations, ensuring fair comparative evaluation.
          </p>
        </div>
      </div>

      <!-- Chart 7: Frequency Heatmap -->
      <div class="card chart-card">
        <div class="card-body">
          <h6 class="card-title">ðŸ”¥ Estimation Range Frequency Distribution</h6>
          <p class="card-text small text-muted">Preferred estimation ranges by AI provider.</p>
          <div class="chart-container">
            <canvas baseChart 
              [data]="frequencyHeatmapChartConfig.data"
              [options]="frequencyHeatmapChartConfig.options"
              [type]="frequencyHeatmapChartConfig.type">
            </canvas>
          </div>
          <p class="small text-muted mt-2 thesis-note">
            <strong>Thesis Angle:</strong> Frequency distributions reveal preferred estimation ranges, indicating conservative vs aggressive prediction strategies.
          </p>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="card mt-4">
      <div class="card-body">
        <h6 class="card-title">Raw Data Table</h6>
        <app-estimation-history-table [history]="estimations"></app-estimation-history-table>
      </div>
    </div>
  </ng-container>
</div>
